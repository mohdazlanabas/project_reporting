<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Landfill Daily Reports</title>
  <style>
    :root {
      --blue: #0d47a1;
      --mid: #1f2937;
      --light: #f3f4f6;
      --card: #ffffff;
      --accent: #22c55e;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--light); color: var(--mid); }
    header { background: var(--blue); color: #fff; padding: 18px 28px; display: flex; align-items: center; justify-content: space-between; }
    main { max-width: 1200px; margin: 0 auto; padding: 24px; }
    h1, h2, h3 { margin: 0 0 12px; }
    section { background: var(--card); border-radius: 10px; padding: 18px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    label { display: block; font-weight: 600; margin-bottom: 6px; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; margin-bottom: 12px; }
    textarea { resize: vertical; }
    button { background: var(--blue); color: #fff; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; font-weight: 700; }
    button.secondary { background: #374151; }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 14px; }
    .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; font-size: 12px; background: #e5e7eb; color: #111827; }
    .flex-between { display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
    #reports-list { list-style: none; padding: 0; margin: 0; }
    #reports-list li { padding: 12px; border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 10px; background: #fff; }
    .muted { color: #6b7280; font-size: 13px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <header>
    <div>
      <div style="font-size: 15px; opacity: 0.85;">Municipal Waste Landfill Facility</div>
      <h1 style="margin: 0; font-size: 22px;">Daily Reporting</h1>
    </div>
    <div class="flex-between">
      <span id="session-info" class="pill">Signed out</span>
      <button id="signout-btn" class="secondary hidden">Sign out</button>
    </div>
  </header>

  <main>
    <div id="auth-view">
      <section>
        <h2>Log In or Register</h2>
        <div class="row">
          <div>
            <label>Email</label>
            <input type="email" id="email" value="admin@example.com" />
          </div>
          <div>
            <label>Password</label>
            <input type="password" id="password" value="changeme123" />
          </div>
        </div>
        <div style="display:flex; gap:12px; flex-wrap: wrap;">
          <button id="login-btn">Log In</button>
          <button id="register-btn" class="secondary">Register</button>
        </div>
      </section>
    </div>

    <div id="app-view" class="hidden">
      <section>
        <div class="flex-between">
          <h2>Daily Data Entry</h2>
          <div class="pill" id="report-status" style="display:none;"></div>
        </div>
        <form id="report-form">
          <div class="grid">
            <div>
              <label>Site</label>
              <select name="siteName" required>
                <option value="">Select site</option>
                <option value="Sungai Udang">Sungai Udang</option>
                <option value="Ampang Jajar">Ampang Jajar</option>
                <option value="Jabi">Jabi</option>
              </select>
            </div>
            <div>
              <label>Report Date</label>
              <input type="date" name="reportDate" required />
            </div>
            <div>
              <label>Status</label>
              <select name="status">
                <option value="">Select</option>
                <option>Open</option>
                <option>Closed</option>
                <option>Maintenance</option>
              </select>
            </div>
            <div>
              <label>Weather (current)</label>
              <input name="weather" placeholder="Sunny / Rain" />
            </div>
            <div>
              <label>Cover Material</label>
              <input name="coverMaterial" />
            </div>
            <div>
              <label>Total Tonnage (MT)</label>
              <input type="number" step="0.01" min="0" name="tonnage" />
            </div>
          </div>

          <h3>Operation Hours</h3>
          <div class="grid">
            <div>
              <label>Start</label>
              <input type="time" name="operationStart" />
            </div>
            <div>
              <label>End</label>
              <input type="time" name="operationEnd" />
            </div>
          </div>

          <h3>Manpower</h3>
          <div class="grid">
            <div><label>Manager</label><input type="number" min="0" name="manpowerManager" value="1" /></div>
            <div><label>Site Engineer</label><input type="number" min="0" name="manpowerSiteEngineer" value="1" /></div>
            <div><label>Jr Engineer</label><input type="number" min="0" name="manpowerJrEngineer" value="1" /></div>
            <div><label>Safety &amp; Health Executive</label><input type="number" min="0" name="manpowerSafety" value="1" /></div>
            <div><label>Operations Supervisor</label><input type="number" min="0" name="manpowerSupervisor" value="2" /></div>
            <div><label>Technician LTP</label><input type="number" min="0" name="manpowerTechnicianLtp" value="2" /></div>
            <div><label>LTP Operator</label><input type="number" min="0" name="manpowerLtpOperator" value="4" /></div>
            <div><label>Housekeeping</label><input type="number" min="0" name="manpowerHousekeeping" value="8" /></div>
            <div><label>Traffic Controller</label><input type="number" min="0" name="manpowerTraffic" value="4" /></div>
            <div><label>Weighbridge Operator</label><input type="number" min="0" name="manpowerWeighbridge" value="1" /></div>
            <div><label>Security Guard</label><input type="number" min="0" name="manpowerSecurity" value="3" /></div>
          </div>

          <h3>Equipment / Machineries</h3>
          <div class="row">
            <div>
              <label>Landfill Compactor (On-site / Operating)</label>
              <div class="grid">
                <input type="number" min="0" name="equipCompactorOnsite" placeholder="On-site" />
                <input type="number" min="0" name="equipCompactorOperating" placeholder="Operating" />
              </div>
            </div>
            <div>
              <label>Excavator</label>
              <div class="grid">
                <input type="number" min="0" name="equipExcavatorOnsite" />
                <input type="number" min="0" name="equipExcavatorOperating" />
              </div>
            </div>
            <div>
              <label>Bulldozer</label>
              <div class="grid">
                <input type="number" min="0" name="equipBulldozerOnsite" />
                <input type="number" min="0" name="equipBulldozerOperating" />
              </div>
            </div>
            <div>
              <label>Dump Truck</label>
              <div class="grid">
                <input type="number" min="0" name="equipDumpTruckOnsite" />
                <input type="number" min="0" name="equipDumpTruckOperating" />
              </div>
            </div>
            <div>
              <label>JCB</label>
              <div class="grid">
                <input type="number" min="0" name="equipJcbOnsite" />
                <input type="number" min="0" name="equipJcbOperating" />
              </div>
            </div>
            <div>
              <label>Water Tanker</label>
              <div class="grid">
                <input type="number" min="0" name="equipWaterTankerOnsite" />
                <input type="number" min="0" name="equipWaterTankerOperating" />
              </div>
            </div>
            <div>
              <label>Long Arm</label>
              <div class="grid">
                <input type="number" min="0" name="equipLongArmOnsite" />
                <input type="number" min="0" name="equipLongArmOperating" />
              </div>
            </div>
            <div>
              <label>Roller Compactor</label>
              <div class="grid">
                <input type="number" min="0" name="equipRollerOnsite" />
                <input type="number" min="0" name="equipRollerOperating" />
              </div>
            </div>
          </div>

          <h3>Activities / Work Record</h3>
          <div class="row">
            <div>
              <label>Operation (location, remarks, actions)</label>
              <textarea name="activitiesOperation" rows="3" placeholder="Phase 2B - litter picking, housekeeping on landfill road, actions taken..."></textarea>
            </div>
            <div>
              <label>LTP</label>
              <textarea name="activitiesLtp" rows="3" placeholder="Air receiver water drained, polymer mixing twice daily, housekeeping..."></textarea>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Project</label>
              <textarea name="activitiesProject" rows="3" placeholder="Access road, bund, tipping platform..."></textarea>
            </div>
            <div>
              <label>Others</label>
              <textarea name="activitiesOthers" rows="3" placeholder="Detention pond monitoring, stream monitoring, etc."></textarea>
            </div>
          </div>

          <h3>Rainfall</h3>
          <div class="grid">
            <div><label>Start Time</label><input type="time" name="rainStart" /></div>
            <div><label>End Time</label><input type="time" name="rainEnd" /></div>
            <div><label>Volume</label><input type="text" name="rainVolume" placeholder="mm" /></div>
            <div><label>Remarks</label><input type="text" name="rainRemarks" placeholder="Monitored twice daily" /></div>
          </div>

          <h3>Next Day Weather Forecast</h3>
          <div class="grid">
            <div><label>Morning</label><input name="forecastMorning" placeholder="Rain" /></div>
            <div><label>Evening</label><input name="forecastEvening" placeholder="Rain" /></div>
            <div><label>Night</label><input name="forecastNight" placeholder="Clear" /></div>
          </div>

          <h3>LTP Final Discharged</h3>
          <div class="grid">
            <div><label>Vol. intake (m3)</label><input type="number" step="0.01" name="ltpVolIntake" /></div>
            <div><label>Vol. discharge (m3)</label><input type="number" step="0.01" name="ltpVolDischarge" /></div>
            <div><label>Prev. day discharge (m3)</label><input type="number" step="0.01" name="ltpPrevDay" /></div>
          </div>

          <h3>Tonnage Received</h3>
          <div class="grid">
            <div><label>Prev. day tonnage</label><input type="number" step="0.01" name="prevDayTonnage" /></div>
            <div><label>Prev. day trips</label><input type="number" step="1" name="prevDayTrips" /></div>
            <div><label>Total tonnage (overall)</label><input type="number" step="0.01" name="totalTonnage" /></div>
            <div><label>Total trips (overall)</label><input type="number" step="1" name="totalTrips" /></div>
            <div><label>Total (Daily)</label><input type="number" step="0.01" name="dailyTotal" /></div>
            <div><label>Total (Monthly)</label><input type="number" step="0.01" name="monthlyTotal" /></div>
          </div>

          <label>Notes</label>
          <textarea name="notes" rows="3" placeholder="Additional notes (soil trips, issues, actions)"></textarea>

          <label>Photos</label>
          <input type="file" name="photos" multiple accept="image/*" />

          <button type="submit">Submit Report</button>
        </form>
      </section>

      <section>
        <div class="flex-between">
          <h2>Past Reports</h2>
          <button id="refresh-btn" class="secondary">Refresh</button>
        </div>
        <ul id="reports-list"></ul>
      </section>
    </div>
  </main>

  <script>
    const apiBase = 'http://localhost:4000';
    let token = localStorage.getItem('jwt');
    const sessionInfo = document.getElementById('session-info');
    const authView = document.getElementById('auth-view');
    const appView = document.getElementById('app-view');
    const signoutBtn = document.getElementById('signout-btn');
    const reportStatus = document.getElementById('report-status');

    function setSignedIn(email) {
      if (email) {
        sessionInfo.textContent = `Signed in: ${email}`;
        sessionInfo.style.background = '#dcfce7';
        sessionInfo.style.color = '#166534';
        authView.classList.add('hidden');
        appView.classList.remove('hidden');
        signoutBtn.classList.remove('hidden');
      } else {
        sessionInfo.textContent = 'Signed out';
        sessionInfo.style.background = '#e5e7eb';
        sessionInfo.style.color = '#111';
        authView.classList.remove('hidden');
        appView.classList.add('hidden');
        signoutBtn.classList.add('hidden');
      }
    }

    async function auth(path) {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const res = await fetch(`${apiBase}/api/auth/${path}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password }),
      });
      const body = await res.json().catch(() => ({}));
      if (!res.ok) {
        alert(body.message || 'Authentication failed');
        return;
      }
      token = body.token;
      localStorage.setItem('jwt', token);
      setSignedIn(body.user?.email || email);
      updateReports();
    }

    document.getElementById('login-btn').onclick = () => auth('login');
    document.getElementById('register-btn').onclick = () => auth('register');

    signoutBtn.onclick = () => {
      token = null;
      localStorage.removeItem('jwt');
      setSignedIn(null);
    };

    function collectExtras(form) {
      const toNumber = (val) => (val === '' || val === null || val === undefined ? null : Number(val));
      const equipment = [
        ['Landfill Compactor', form.equipCompactorOnsite.value, form.equipCompactorOperating.value],
        ['Excavator', form.equipExcavatorOnsite.value, form.equipExcavatorOperating.value],
        ['Bulldozer', form.equipBulldozerOnsite.value, form.equipBulldozerOperating.value],
        ['Dump Truck', form.equipDumpTruckOnsite.value, form.equipDumpTruckOperating.value],
        ['JCB', form.equipJcbOnsite.value, form.equipJcbOperating.value],
        ['Water Tanker', form.equipWaterTankerOnsite.value, form.equipWaterTankerOperating.value],
        ['Long Arm', form.equipLongArmOnsite.value, form.equipLongArmOperating.value],
        ['Roller Compactor', form.equipRollerOnsite.value, form.equipRollerOperating.value],
      ].map(([type, onsite, operating]) => ({ type, onsite: toNumber(onsite), operating: toNumber(operating) }));

      const manpower = {
        manager: toNumber(form.manpowerManager.value),
        siteEngineer: toNumber(form.manpowerSiteEngineer.value),
        jrEngineer: toNumber(form.manpowerJrEngineer.value),
        safetyHealth: toNumber(form.manpowerSafety.value),
        supervisor: toNumber(form.manpowerSupervisor.value),
        technicianLtp: toNumber(form.manpowerTechnicianLtp.value),
        ltpOperator: toNumber(form.manpowerLtpOperator.value),
        housekeeping: toNumber(form.manpowerHousekeeping.value),
        trafficController: toNumber(form.manpowerTraffic.value),
        weighbridgeOperator: toNumber(form.manpowerWeighbridge.value),
        securityGuard: toNumber(form.manpowerSecurity.value),
      };

      const extras = {
        operationHours: { start: form.operationStart.value, end: form.operationEnd.value },
        manpower,
        equipment,
        activities: {
          operation: form.activitiesOperation.value,
          ltp: form.activitiesLtp.value,
          project: form.activitiesProject.value,
          others: form.activitiesOthers.value,
        },
        rainfall: {
          start: form.rainStart.value,
          end: form.rainEnd.value,
          volume: form.rainVolume.value,
          remarks: form.rainRemarks.value,
        },
        weatherForecast: {
          morning: form.forecastMorning.value,
          evening: form.forecastEvening.value,
          night: form.forecastNight.value,
        },
        ltpFinalDischarge: {
          volIntake: toNumber(form.ltpVolIntake.value),
          volDischarge: toNumber(form.ltpVolDischarge.value),
          prevDay: toNumber(form.ltpPrevDay.value),
        },
        tonnageBreakdown: {
          prevDayTonnage: toNumber(form.prevDayTonnage.value),
          prevDayTrips: toNumber(form.prevDayTrips.value),
          totalTonnage: toNumber(form.totalTonnage.value),
          totalTrips: toNumber(form.totalTrips.value),
          dailyTotal: toNumber(form.dailyTotal.value),
          monthlyTotal: toNumber(form.monthlyTotal.value),
        },
      };

      return extras;
    }

    document.getElementById('report-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!token) {
        alert('Please log in first.');
        return;
      }
      const form = e.target;
      const formData = new FormData(form);
      formData.set('tonnage', form.tonnage.value || '');
      formData.append('extras', JSON.stringify(collectExtras(form)));

      reportStatus.style.display = 'none';

      const res = await fetch(`${apiBase}/api/reports`, {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}` },
        body: formData,
      });
      const body = await res.json().catch(() => ({}));
      if (!res.ok) {
        alert(body.message || 'Failed to save report');
        return;
      }
      form.reset();
      reportStatus.style.display = 'inline-block';
      reportStatus.textContent = 'Saved';
      reportStatus.style.background = '#dcfce7';
      reportStatus.style.color = '#166534';
      updateReports();
    });

    async function updateReports() {
      if (!token) return;
      const res = await fetch(`${apiBase}/api/reports`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (!res.ok) return;
      const data = await res.json();
      const list = document.getElementById('reports-list');
      list.innerHTML = '';
      data.items.forEach((item) => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${item.site_name}</strong> â€” ${item.report_date} <span class="pill">${item.status || 'N/A'}</span><br/><span class="muted">${item.tonnage || 0} MT | Weather: ${item.weather || '-'} | By: ${item.created_by_email || 'unknown'}</span>`;
        list.appendChild(li);
      });
    }

    document.getElementById('refresh-btn').onclick = updateReports;

    if (token) {
      setSignedIn('session active');
      updateReports();
    }
  </script>
</body>
</html>
